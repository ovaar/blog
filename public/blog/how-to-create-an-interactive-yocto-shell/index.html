<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Ovaar"><meta name=description content="Software Engineering blog"><title>How to create an interactive Yocto shell - Ovaar - Software engineering blog</title><link rel=stylesheet href=/css/stylesheet.min.css><link href rel=feed type=application/rss+xml title="Ovaar - Software engineering blog"><script src=/theme-toggle.min.js></script></head><body><header><nav><a href=https://ovaar.github.io/>Ovaar - Software engineering blog</a><ul><li><a href=https://ovaar.github.io/>Home</a></li><li><a href=https://ovaar.github.io/blog/>Blog</a></li><li><a href=/tags>Tags</a></li><li><button id=theme-toggle class=theme-toggle aria-label="Toggle theme mode">
<svg class="light-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
<svg class="dark-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></button></li></ul></nav><h1>How to create an interactive Yocto shell</h1><p><small>published on Mon, 20 Jul 2020</small></p></header><hr><main><div class=tags><a href=/tags/linux class=tag>#linux</a>
<a href=/tags/yocto class=tag>#yocto</a></div><article class=content><p>This post is about a feature request which I have implemented, at time of writing, about 2 years back. It always stuck with me because the project I was doing at the time was my first yocto experience. Topic has its own <a href=https://github.com/topic-embedded-products/topic-platform>BSP</a> for FPGA boards on top of a Linux distribution. A custom board was specifically designed for a customor which would run our software that would interface with another custom low power embedded device.</p><p>Due to an increasing demand of delivering production ready devices to our customer, delivering actual software features became more and more challenging. Making the devices production ready required some manual steps and was something we did in-house.</p><ol><li>Create a bootable SD card with a yocto image containing an <a href=https://github.com/sbabic/swupdate>swupdate</a> package</li><li>Erase NOR-flash</li><li>Run swupdate and select the right boot partition</li><li>Erase EEPROM</li><li>Write MAC address to EEPROM</li></ol><p>This turned out to be error sensitive process. So I decided to create a script which restricts the user input and does validation on the MAC address. Also it could flash the swupdate package, erase flash, write to EEPROM, erase the EEPROM and would prompt the user to select the boot partition to write the swupdate package to. Now I had the script, but still I needed to enter user credentials every time I booted from the SD-card. Would it not be great to bypass the getty login prompt and then run the script interactively ðŸ¤“!</p><p>Enough talk, lets dive in&mldr;.</p><p>Bitbake allows for running code after succesfully building the root filesystem. The <code>ROOTFS_POSTPROCESS_COMMAND</code> allowed to edit the getty systemd service files using <a href=https://www.gnu.org/software/sed/manual/sed.html>sed</a>. Most importantly if you would open <code>console-getty.service</code> it runs <code>agetty</code> on the terminal in order to prompt for the user login. That not what I wanted, so I replaced it with <code>stty</code>.</p><p><code>console-getty.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Unit]</span>
</span></span><span class=line><span class=cl><span class=na>Description</span><span class=o>=</span><span class=s>Console Getty</span>
</span></span><span class=line><span class=cl><span class=na>After</span><span class=o>=</span><span class=s>systemd-user-sessions.service plymouth-quit-wait.service</span>
</span></span><span class=line><span class=cl><span class=na>Before</span><span class=o>=</span><span class=s>getty.target</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>-/sbin/agetty --noclear --keep-baud console 115200,38400,9600 $TERM</span>
</span></span><span class=line><span class=cl><span class=na>Type</span><span class=o>=</span><span class=s>idle</span>
</span></span><span class=line><span class=cl><span class=na>Restart</span><span class=o>=</span><span class=s>always</span>
</span></span><span class=line><span class=cl><span class=na>RestartSec</span><span class=o>=</span><span class=s>0</span>
</span></span><span class=line><span class=cl><span class=na>UtmpIdentifier</span><span class=o>=</span><span class=s>cons</span>
</span></span><span class=line><span class=cl><span class=na>TTYPath</span><span class=o>=</span><span class=s>/dev/console</span>
</span></span><span class=line><span class=cl><span class=na>TTYReset</span><span class=o>=</span><span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>TTYVHangup</span><span class=o>=</span><span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>KillMode</span><span class=o>=</span><span class=s>process</span>
</span></span><span class=line><span class=cl><span class=na>IgnoreSIGPIPE</span><span class=o>=</span><span class=s>no</span>
</span></span><span class=line><span class=cl><span class=na>SendSIGHUP</span><span class=o>=</span><span class=s>yes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Install]</span>
</span></span><span class=line><span class=cl><span class=na>WantedBy</span><span class=o>=</span><span class=s>getty.target</span>
</span></span></code></pre></div><p><code>interactive.bb</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>GETTY_SYSTEMD_SERVICES</span> <span class=err>?</span><span class=o>=</span> <span class=s2>&#34; </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    $</span><span class=si>{IMAGE_ROOTFS}</span><span class=s2>$</span><span class=si>{systemd_system_unitdir}</span><span class=s2>/serial-getty@.service </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    $</span><span class=si>{IMAGE_ROOTFS}</span><span class=s2>$</span><span class=si>{systemd_system_unitdir}</span><span class=s2>/console-getty.service </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    $</span><span class=si>{IMAGE_ROOTFS}</span><span class=s2>$</span><span class=si>{systemd_system_unitdir}</span><span class=s2>/getty@.service </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>    $</span><span class=si>{IMAGE_ROOTFS}</span><span class=s2>$</span><span class=si>{systemd_system_unitdir}</span><span class=s2>/container-getty@.service </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Replace agetty, which prompts for a user login</span>
</span></span><span class=line><span class=cl><span class=c1># with stty. Than disable tty reset and hangup to</span>
</span></span><span class=line><span class=cl><span class=c1># continue the user input stream.</span>
</span></span><span class=line><span class=cl><span class=n>disable_login_prompt</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sed</span> <span class=o>-</span><span class=n>i</span> <span class=o>-</span><span class=n>e</span> <span class=s1>&#39;s/^\(ExecStart *=\(.*\)$\)/ExecStart=-\/bin\/stty -F \/dev\/ttyPS0 115200 cs8 sane /&#39;</span> <span class=err>$</span><span class=p>{</span><span class=n>GETTY_SYSTEMD_SERVICES</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>sed</span> <span class=o>-</span><span class=n>i</span> <span class=o>-</span><span class=n>e</span> <span class=s1>&#39;s/^\(TTYVHangup=yes$\)/TTYVHangup=no/&#39;</span> <span class=err>$</span><span class=p>{</span><span class=n>GETTY_SYSTEMD_SERVICES</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>sed</span> <span class=o>-</span><span class=n>i</span> <span class=o>-</span><span class=n>e</span> <span class=s1>&#39;s/^\(TTYReset=yes$\)/TTYReset=no/&#39;</span> <span class=err>$</span><span class=p>{</span><span class=n>GETTY_SYSTEMD_SERVICES</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ROOTFS_POSTPROCESS_COMMAND</span> <span class=o>+=</span> <span class=s2>&#34;disable_login_prompt;&#34;</span>
</span></span></code></pre></div><p>Next create a systemd service which runs after getty has started which to execute the interactive script.</p><p><code>interactive.service</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Unit]</span>
</span></span><span class=line><span class=cl><span class=na>Description</span><span class=o>=</span><span class=s>Interactive installation script that runs at startup.</span>
</span></span><span class=line><span class=cl><span class=na>After</span><span class=o>=</span><span class=s>getty.target multi-user.target</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>Type</span><span class=o>=</span><span class=s>oneshot</span>
</span></span><span class=line><span class=cl><span class=na>RemainAfterExit</span><span class=o>=</span><span class=s>yes</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>/home/root/run-interactive-script</span>
</span></span><span class=line><span class=cl><span class=na>StandardInput</span><span class=o>=</span><span class=s>tty-force</span>
</span></span><span class=line><span class=cl><span class=na>StandardOutput</span><span class=o>=</span><span class=s>inherit</span>
</span></span><span class=line><span class=cl><span class=na>StandardError</span><span class=o>=</span><span class=s>inherit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Install]</span>
</span></span><span class=line><span class=cl><span class=na>WantedBy</span><span class=o>=</span><span class=s>multi-user.target</span>
</span></span></code></pre></div><p>Now you can boot your system without an user login promp but still access all features of your BSP running Linux.</p></article></main><footer><footer><hr><div class=footer-content><div class=footer-info><p><small>Copyright &#169; 2020 Ovaar. This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</small></p><p><small>created with <a href=https://gohugo.io>Hugo</a>,
<a href=https://github.com/andybrewer/mvp>mvp.css</a>.</small></p></div><div class=footer-social><div class=social><a href=https://github.com/ovaar target=_blank rel="noopener noreferrer" aria-label="github profile"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=https://www.linkedin.com/in/thomas-reynders-6bb57057/ target=_blank rel="noopener noreferrer" aria-label="linkedin profile"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></div></div></footer></footer></body></html>