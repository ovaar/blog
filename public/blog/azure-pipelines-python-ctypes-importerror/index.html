<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Ovaar"><meta name=description content="Software Engineering blog"><title>Azure pipelines - ctypes importerror - Ovaar - Software engineering blog</title><link rel=stylesheet href=/css/stylesheet.min.css><link href rel=feed type=application/rss+xml title="Ovaar - Software engineering blog"><script src=/theme-toggle.min.js></script></head><body><header><nav><a href=/>Ovaar - Software engineering blog</a><ul><li><a href=/>Home</a></li><li><a href=/blog/>Blog</a></li><li><a href=/tags>Tags</a></li><li><button id=theme-toggle class=theme-toggle aria-label="Toggle theme mode">
<svg class="light-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
<svg class="dark-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></button></li></ul></nav><h1>Azure pipelines - ctypes importerror</h1><p><small>published on Fri, 31 Jan 2025</small></p></header><hr><main><div class=tags><a href=/tags/devops class=tag>#devops</a>
<a href=/tags/python class=tag>#python</a></div><article class=content><h1 id=fixing-ctypes-importerror-in-azure-pipelines-missing-_type_-attribute>Fixing <code>ctypes</code> ImportError in Azure Pipelines: Missing <code>_type_</code> Attribute</h1><p>When running <code>pip install</code> in an Azure Pipelines self-hosted agent, you might encounter the following error:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>File &#34;~\myselfhostedagent\_work\_tool\Python\3.12.3\x64\Lib\site-packages\pip\_vendor\platformdirs\windows.py&#34;, line 254, in _pick_get_win_folder
</span></span><span class=line><span class=cl>    import ctypes  # noqa: PLC0415
</span></span><span class=line><span class=cl>    ^^^^^^^^^^^^^
</span></span><span class=line><span class=cl>  File &#34;ctypes\__init__.py&#34;, line 157, in &lt;module&gt;
</span></span><span class=line><span class=cl>AttributeError: class must define a &#39;_type_&#39; attribute
</span></span></code></pre></div><p>Interestingly, if you manually execute <code>pip install</code> using the same <code>python.exe</code>, it works fine. However, when executed within the Azure Pipelines agent, it fails.</p><p>In this post, we&rsquo;ll explore why this happens and how to fix it.</p><hr><h2 id=-why-does-this-happen>ðŸš¨ <strong>Why Does This Happen?</strong></h2><h3 id=1-pythons-dll-handling-in-windows><strong>1. Pythonâ€™s DLL Handling in Windows</strong></h3><p>A typical Python installation on Windows consists of:</p><ul><li><code>python.exe</code> in <code>&lt;PYTHON_ROOT></code>.</li><li>Standard libraries in <code>&lt;PYTHON_ROOT>\Lib</code>.</li><li>DLLs (such as <code>_ctypes.pyd</code>, <code>_queue.pyd</code>) in <code>&lt;PYTHON_ROOT>\DLLs</code></li></ul><p>Before Python 3.8, Windows would automatically find these DLLs when needed. However, since <strong>Python 3.8</strong>, Microsoft tightened security, and Python now explicitly controls how DLLs are loaded using <a href=https://docs.python.org/3/library/os.html#os.add_dll_directory><code>os.add_dll_directory()</code></a>.</p><h3 id=2-the-azure-pipelines-environment-is-different><strong>2. The Azure Pipelines Environment Is Different</strong></h3><ul><li>When you run <code>python.exe</code> manually, your user session <strong>automatically resolves</strong> the <code>DLLs</code> directory.</li><li>When the Azure Pipelines agent runs Python, it <strong>starts in a minimal environment</strong>, and Windows <strong>does not find the required DLLs</strong> unless they are explicitly referenced.</li></ul><h3 id=3-why-pip-fails><strong>3. Why pip Fails</strong></h3><p>The <code>ctypes</code> module relies on system DLLs to function. Since the Python DLLs directory is not in <code>PATH</code>, Windows fails to load necessary components, resulting in:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>AttributeError: class must define a &#39;_type_&#39; attribute
</span></span></code></pre></div><hr><h2 id=-how-to-fix-it>âœ… <strong>How to Fix It</strong></h2><p>To ensure the agent can find the DLLs, <strong>prepend the <code>DLLs</code> directory</strong> to the PATH in the pipeline:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>script</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      PYTHON_ROOT=$(python -c &#34;import sys; import os; print(os.path.dirname(sys.executable))&#34;)
</span></span></span><span class=line><span class=cl><span class=sd>      echo &#34;##vso[task.prependpath]${PYTHON_ROOT}/DLLs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>displayName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Fix Python DLL Path&#34;</span><span class=w>
</span></span></span></code></pre></div><p>This tells Windows to search Pythonâ€™s <code>DLLs</code> directory when loading system dependencies.</p><hr><h2 id=-minimal-azure-pipelines-yaml-file>ðŸ”§ <strong>Minimal Azure Pipelines YAML File</strong></h2><p>Hereâ€™s a minimal example including <code>UsePythonVersion@0</code> to ensure the correct Python version is used:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>trigger</span><span class=p>:</span><span class=w> </span><span class=l>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>pool</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Self-Hosted-Agent-Pool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>task</span><span class=p>:</span><span class=w> </span><span class=l>UsePythonVersion@0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>inputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>versionSpec</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.12&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>addToPath</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>script</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      PYTHON_ROOT=$(python -c &#34;import sys; import os; print(os.path.dirname(sys.executable))&#34;)
</span></span></span><span class=line><span class=cl><span class=sd>      echo &#34;##vso[task.prependpath]${PYTHON_ROOT}/DLLs&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>displayName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Fix Python DLL Path&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>script</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      python -m pip install --upgrade pip
</span></span></span><span class=line><span class=cl><span class=sd>      python -m pip install -r requirements.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>displayName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Install Dependencies&#34;</span><span class=w>
</span></span></span></code></pre></div><hr><h2 id=-alternative-use->ðŸ“Œ **Alternative: Use **``</h2><p>If you prefer not to modify <code>PATH</code>, you can explicitly set the DLL directory inside your Python script before using <code>ctypes</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dll_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>executable</span><span class=p>),</span> <span class=s2>&#34;DLLs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>add_dll_directory</span><span class=p>(</span><span class=n>dll_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>ctypes</span>  <span class=c1># This should now work correctly</span>
</span></span></code></pre></div><p>However, setting <code>PATH</code> in the pipeline is a more universal fix, ensuring all Python processes in the build agent work without modification.</p><hr><h2 id=-conclusion>ðŸŽ¯ <strong>Conclusion</strong></h2><ul><li><strong>Why does this happen?</strong> Windows no longer automatically searches Pythonâ€™s <code>DLLs</code> folder.</li><li><strong>Why only in Azure Pipelines?</strong> The agent runs with a minimal environment that lacks the required paths.</li><li><strong>How to fix it?</strong> Prepend the <code>DLLs</code> directory to <code>PATH</code> in the pipeline or use <code>os.add_dll_directory()</code> in Python scripts.</li></ul><p>By applying this fix, you can prevent <code>pip install</code> and <code>ctypes</code>-related failures in your Azure Pipelines self-hosted agent.</p><p>Happy coding! ðŸš€</p></article></main><footer><footer><hr><div class=footer-content><div class=footer-info><p><small>Copyright &#169; 2020 Ovaar. This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</small></p><p><small>created with <a href=https://gohugo.io>Hugo</a>,
<a href=https://github.com/andybrewer/mvp>mvp.css</a>.</small></p></div><div class=footer-social><div class=social><a href=https://github.com/ovaar target=_blank rel="noopener noreferrer" aria-label="github profile"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=https://www.linkedin.com/in/thomas-reynders-6bb57057/ target=_blank rel="noopener noreferrer" aria-label="linkedin profile"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></div></div></footer></footer></body></html>