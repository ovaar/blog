<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Ovaar"><meta name=description content="Software Engineering blog"><title>Azure pipelines cross-platform scripts - Ovaar - Software engineering blog</title><link rel=stylesheet href=/css/stylesheet.min.css><link href rel=feed type=application/rss+xml title="Ovaar - Software engineering blog"><script src=/theme-toggle.min.js></script></head><body><header><nav><a href=/>Ovaar - Software engineering blog</a><ul><li><a href=/>Home</a></li><li><a href=/blog/>Blog</a></li><li><a href=/tags>Tags</a></li><li><button id=theme-toggle class=theme-toggle aria-label="Toggle theme mode">
<svg class="light-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
<svg class="dark-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></button></li></ul></nav><h1>Azure pipelines cross-platform scripts</h1><p><small>published on Thu, 01 Aug 2024</small></p></header><hr><main><div class=tags><a href=/tags/devops class=tag>#devops</a>
<a href=/tags/azure class=tag>#azure</a></div><article class=content><h1 id=azure-pipelines-cross-platform-scripts>Azure pipelines cross-platform scripts</h1><p>To keep things simple when setting up a CI/CD pipeline for a cross-platform application we cautiously have to consider our options for running the steps in what scripting language, because we don&rsquo;t want to end up with scripts that do the same thing functionally, but are different for each platform, which means extra maintenance and complexity for the maintainers.</p><p>So we have to consider languages like Powershell, Bash, Zsh or Python for to run on Windows, macOS and Linux.</p><h2 id=bash-or-powershell>Bash or Powershell</h2><p>By default Linux and macOS come with Bash installed, except for Windows, though its likely that your Windows machine already has Git Bash or Window Subsystem for Linux installed.</p><p>I personally prefer Bash, because I find that the amount of text I need to write in Powershell in comparison to Bash to accomplish something is to big. Secondly, Bash is such a commonly used
scripting language and it is so easy to find on the internet how to implement something that the productivity is much higher.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># Git for Windows v2.45.2</span>
</span></span><span class=line><span class=cl>$ bash --version
</span></span><span class=line><span class=cl>GNU bash, version 5.2.26<span class=o>(</span>1<span class=o>)</span>-release <span class=o>(</span>x86_64-pc-msys<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bash on Mac Pro 2023 (12.7.5 Monterey)</span>
</span></span><span class=line><span class=cl>$ bash --version
</span></span><span class=line><span class=cl>GNU bash, version 3.2.57<span class=o>(</span>1<span class=o>)</span>-release <span class=o>(</span>x86_64-apple-darwin21<span class=o>)</span>
</span></span><span class=line><span class=cl>Copyright <span class=o>(</span>C<span class=o>)</span> <span class=m>2007</span> Free Software Foundation, Inc.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bash on Mac Mini M1 2020 (14.5 Sonoma)</span>
</span></span><span class=line><span class=cl>$ bash --version
</span></span><span class=line><span class=cl>GNU bash, version 3.2.57<span class=o>(</span>1<span class=o>)</span>-release <span class=o>(</span>arm64-apple-darwin23<span class=o>)</span>
</span></span><span class=line><span class=cl>Copyright <span class=o>(</span>C<span class=o>)</span> <span class=m>2007</span> Free Software Foundation, Inc.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bash on Ubuntu (20.24 Focal Fossa)</span>
</span></span><span class=line><span class=cl>$ bash --version
</span></span><span class=line><span class=cl>GNU bash, version 5.0.6<span class=o>(</span>1<span class=o>)</span>-release <span class=o>(</span>x86_64<span class=o>)</span>
</span></span></code></pre></div><p>As you can see there are quite some differences in versions between platforms. Especially, macOS comes with an ancient version of Bash, which reduces the amount of modern Bash feature you can use. Depending on your needs this could be a limiting factor, though with you&rsquo;ll often find that with a limiting amount of changes you can achieve the same thing.</p><h3 id=preparing-git-for-windows>Preparing Git for Windows</h3><p>To prepare the Windows agent install <a href=https://git-scm.com/download/win>Git for Windows</a> and make sure to add the <code>C:\Program Files\Git\bin</code> directory to the PATH.</p><h2 id=the-pipeline-definition>The pipeline definition</h2><p>Let get started by creating a <code>azure-pipelines.yml</code> file and setup our platform parameters so that the pipeline can conditionally be run. Next we&rsquo;ll utilize a <a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/yaml-schema/jobs-job-strategy?view=azure-pipelines#build-on-multiple-platforms">jobs strategy matrix</a> to start the pipeline on the selected platforms&rsquo; agents.</p><p>Resulting in each agent running the step &ldquo;Getting started&rdquo; that will print something to our terminal.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># azure-pipelines.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cross_platform_ci</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>windows_vs_2022</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>boolean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>macOS_x86_64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>boolean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>macos_arm64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>boolean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu_x86_64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>boolean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>pool</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>$(poolName)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>displayName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Pipeline job&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span><span class=c># https://learn.microsoft.com/en-us/azure/devops/pipelines/yaml-schema/jobs-job-strategy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matrix</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>${{ if eq(parameters.windows_vs_2022, true) }}:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>windows_vs_2022</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>poolName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;windows_vs_2022&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>${{ if eq(parameters.macOS_x86_64, true) }}:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>macOS_x86_64</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>poolName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;macOS_x86_64&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>${{ if eq(parameters.macos_arm64, true) }}:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>macOS_arm64</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>poolName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;macos_arm64&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=l>${{ if eq(parameters.ubuntu_x86_64, true) }}:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ubuntu_x86_64</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>poolName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ubuntu_x86_64&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>bash</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          set -euo pipefail
</span></span></span><span class=line><span class=cl><span class=sd>          echo &#34;Hello Azure pipeline from $AGENT_OS!&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>displayName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Getting started&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=failing-a-bash-step-in-azure-pipelines>Failing a Bash step in Azure pipelines</h3><p>By default commands that are executed in a Bash step will not fail the pipeline if they returned a non-zero exit code, unless we explicitly tell bash to fail.</p><p>We can set these options using <a href=https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html>Bash Set</a>.</p><p>I personally prefer setting the following options</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>set</span> -euo pipefail
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># -e Exit immediately if a pipeline returns a non-zero status</span>
</span></span><span class=line><span class=cl><span class=c1># -u Treat unset variables and parameters as an error when performing parameter expansion.</span>
</span></span><span class=line><span class=cl><span class=c1># -o pipefail Exit if a pipe returns a non-zero status</span>
</span></span></code></pre></div></article></main><footer><footer><hr><div class=footer-content><div class=footer-info><p><small>Copyright &#169; 2020 Ovaar. This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</small></p><p><small>created with <a href=https://gohugo.io>Hugo</a>,
<a href=https://github.com/andybrewer/mvp>mvp.css</a>.</small></p></div><div class=footer-social><div class=social><a href=https://github.com/ovaar target=_blank rel="noopener noreferrer" aria-label="github profile"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=https://www.linkedin.com/in/thomas-reynders-6bb57057/ target=_blank rel="noopener noreferrer" aria-label="linkedin profile"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></div></div></footer></footer></body></html>